<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for the productivity chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the application */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s ease;
        }
        /* Custom transition for smooth color changes */
        .transition-colors-background {
            transition: background-color 0.5s ease-in-out;
        }
        /* Styling for the settings modal */
        #settings-modal {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-red-100 transition-colors-background">

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md mx-auto bg-white/30 backdrop-blur-sm rounded-2xl shadow-lg p-6 md:p-8">
            
            <!-- Header with Title and Settings Button -->
            <header class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Pomodoro</h1>
                <button id="settings-btn" class="text-gray-600 hover:text-gray-900 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </header>

            <!-- Mode Tabs -->
            <div class="flex justify-center space-x-2 md:space-x-4 mb-8 bg-black/5 p-2 rounded-full">
                <button data-mode="pomodoro" class="mode-btn flex-1 py-2 px-4 rounded-full text-sm md:text-base font-semibold transition-all duration-300">Pomodoro</button>
                <button data-mode="shortBreak" class="mode-btn flex-1 py-2 px-4 rounded-full text-sm md:text-base font-semibold transition-all duration-300">Short Break</button>
                <button data-mode="longBreak" class="mode-btn flex-1 py-2 px-4 rounded-full text-sm md:text-base font-semibold transition-all duration-300">Long Break</button>
            </div>

            <!-- Timer Display -->
            <div class="flex justify-center items-center mb-8">
                <p id="timer-display" class="text-7xl md:text-8xl font-extrabold text-gray-900 tracking-tighter">25:00</p>
            </div>

            <!-- Control Buttons -->
            <div class="flex justify-center space-x-4">
                <button id="start-pause-btn" class="w-32 py-3 px-6 bg-gray-800 text-white font-bold rounded-full shadow-lg hover:bg-gray-900 transform hover:scale-105 transition-all duration-300">
                    START
                </button>
                <button id="reset-btn" class="py-3 px-6 bg-gray-200 text-gray-700 font-bold rounded-full shadow-lg hover:bg-gray-300 transform hover:scale-105 transition-all duration-300">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path opacity="0.5" fill-rule="evenodd" clip-rule="evenodd" d="M6.87348 7.87338C9.01606 5.7308 12.1674 5.20902 14.8007 6.31041L15.9309 5.18019C12.6515 3.53111 8.55119 4.07435 5.81282 6.81272C2.39573 10.2298 2.39573 15.77 5.81282 19.1871C9.2299 22.6042 14.7701 22.6042 18.1872 19.1871C20.1746 17.1997 21.0057 14.4933 20.6819 11.9072C20.6304 11.4962 20.2555 11.2048 19.8445 11.2562C19.4335 11.3077 19.142 11.6826 19.1935 12.0936C19.4622 14.24 18.7727 16.4802 17.1265 18.1264C14.2952 20.9577 9.70478 20.9577 6.87348 18.1264C4.04217 15.2951 4.04217 10.7047 6.87348 7.87338Z" fill="black"/>
                  <path d="M18.7212 4.20119C18.7212 3.89785 18.5384 3.62437 18.2582 3.50828C17.9779 3.3922 17.6553 3.45637 17.4408 3.67086L15.9314 5.18028L14.8012 6.3105L13.1982 7.9135C12.9837 8.128 12.9195 8.45059 13.0356 8.73085C13.1517 9.0111 13.4252 9.19383 13.7285 9.19383H17.9712C18.3854 9.19383 18.7212 8.85805 18.7212 8.44383V4.20119Z" fill="black"/>
                  </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Settings</h2>
                <button id="close-settings-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            
            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Timer Durations (minutes)</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="pomodoro-duration" class="block text-sm font-medium text-gray-600">Pomodoro</label>
                            <input type="number" id="pomodoro-duration" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        </div>
                        <div>
                            <label for="short-break-duration" class="block text-sm font-medium text-gray-600">Short Break</label>
                            <input type="number" id="short-break-duration" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        </div>
                        <div>
                            <label for="long-break-duration" class="block text-sm font-medium text-gray-600">Long Break</label>
                            <input type="number" id="long-break-duration" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Productivity (Last 7 Days)</h3>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <canvas id="pomodoro-chart"></canvas>
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button id="save-settings-btn" class="py-2 px-6 bg-gray-800 text-white font-bold rounded-full shadow-lg hover:bg-gray-900 transform hover:scale-105 transition-all duration-300">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const timerDisplay = document.getElementById('timer-display');
            const startPauseBtn = document.getElementById('start-pause-btn');
            const resetBtn = document.getElementById('reset-btn');
            const modeButtons = document.querySelectorAll('.mode-btn');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsBtn = document.getElementById('close-settings-btn');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const pomodoroDurationInput = document.getElementById('pomodoro-duration');
            const shortBreakDurationInput = document.getElementById('short-break-duration');
            const longBreakDurationInput = document.getElementById('long-break-duration');
            const chartCanvas = document.getElementById('pomodoro-chart');

            // Timer state
            let timerInterval = null;
            let currentMode = 'pomodoro';
            let timeRemaining = 25 * 60; // in seconds
            let isRunning = false;
            let pomodoroChart = null;

            // Timer durations (in minutes)
            let durations = {
                pomodoro: 25,
                shortBreak: 5,
                longBreak: 15
            };
            
            // --- Native Web Audio API for Sound ---
            let audioContext;

            // This function creates a self-contained sound player.
            function playNote(frequency, duration, startTime) {
                try {
                    // Create AudioContext on the first user interaction
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    
                    // In some browsers, the audio context starts suspended.
                    // Resume it on user gesture.
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    
                    const time = startTime || audioContext.currentTime;

                    // Create an oscillator (the sound source)
                    const oscillator = audioContext.createOscillator();
                    oscillator.type = 'sine'; // A smooth, clean tone
                    oscillator.frequency.setValueAtTime(frequency, time);

                    // Create a gain node to control volume and prevent clipping
                    const gainNode = audioContext.createGain();
                    gainNode.gain.setValueAtTime(0.5, time); // Increased volume from 0.2 to 0.5
                    gainNode.gain.exponentialRampToValueAtTime(0.0001, time + duration);

                    // Connect the nodes: oscillator -> gain -> destination (speakers)
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    // Start and stop the sound
                    oscillator.start(time);
                    oscillator.stop(time + duration);
                } catch (e) {
                    console.error("Web Audio API error:", e);
                }
            }

            const playClickSound = () => {
                playNote(440, 0.1); // A short, medium-pitched click (A4 note)
            };

            const playEndSound = () => {
                // Ensure audio context is ready before scheduling notes
                if (!audioContext) {
                    try {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    } catch (e) {
                        console.error("Could not create AudioContext:", e);
                        return; // Exit if audio context cannot be created
                    }
                }
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                const now = audioContext.currentTime;
                // Play a longer, more noticeable 3-note melody
                playNote(523.25, 0.2, now);        // C5
                playNote(659.25, 0.2, now + 0.2);  // E5
                playNote(783.99, 0.4, now + 0.4);  // G5, held longer
            };


            // --- Local Storage for Persistence ---
            function saveSettings() {
                localStorage.setItem('pomodoroDurations', JSON.stringify(durations));
            }

            function loadSettings() {
                const savedDurations = localStorage.getItem('pomodoroDurations');
                if (savedDurations) {
                    durations = JSON.parse(savedDurations);
                }
                pomodoroDurationInput.value = durations.pomodoro;
                shortBreakDurationInput.value = durations.shortBreak;
                longBreakDurationInput.value = durations.longBreak;
            }
            
            function getPomodoroStats() {
                return JSON.parse(localStorage.getItem('pomodoroStats')) || {};
            }

            function savePomodoroStats(stats) {
                localStorage.setItem('pomodoroStats', JSON.stringify(stats));
            }

            function recordPomodoroCompletion() {
                const stats = getPomodoroStats();
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                stats[today] = (stats[today] || 0) + 1;
                savePomodoroStats(stats);
            }


            // --- UI Update Functions ---
            function updateTimerDisplay() {
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                timerDisplay.textContent = formattedTime;
                document.title = `${formattedTime} - ${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)}`;
            }

            function updateModeUI() {
                document.body.classList.remove('bg-red-100', 'bg-blue-100', 'bg-green-100');
                modeButtons.forEach(btn => {
                    btn.classList.remove('bg-gray-800', 'text-white', 'shadow-inner');
                    btn.classList.add('text-gray-600');
                });

                const activeBtn = document.querySelector(`[data-mode="${currentMode}"]`);
                if (currentMode === 'pomodoro') {
                    document.body.classList.add('bg-red-100');
                    if (activeBtn) activeBtn.classList.add('bg-gray-800', 'text-white', 'shadow-inner');
                } else if (currentMode === 'shortBreak') {
                    document.body.classList.add('bg-blue-100');
                    if (activeBtn) activeBtn.classList.add('bg-gray-800', 'text-white', 'shadow-inner');
                } else { // longBreak
                    document.body.classList.add('bg-green-100');
                    if (activeBtn) activeBtn.classList.add('bg-gray-800', 'text-white', 'shadow-inner');
                }
            }
            
            // --- Timer Logic ---
            function switchMode(mode) {
                currentMode = mode;
                resetTimer();
                updateModeUI();
            }

            function startTimer() {
                if (isRunning) return;
                isRunning = true;
                startPauseBtn.textContent = 'PAUSE';
                timerInterval = setInterval(() => {
                    timeRemaining--;
                    updateTimerDisplay();
                    if (timeRemaining <= 0) {
                        clearInterval(timerInterval);
                        isRunning = false;
                        playEndSound();
                        startPauseBtn.textContent = 'START';
                        if(currentMode === 'pomodoro') {
                            recordPomodoroCompletion();
                            updateChart();
                        }
                    }
                }, 1000);
            }

            function pauseTimer() {
                if (!isRunning) return;
                isRunning = false;
                startPauseBtn.textContent = 'START';
                clearInterval(timerInterval);
            }

            function resetTimer() {
                pauseTimer();
                timeRemaining = durations[currentMode] * 60;
                updateTimerDisplay();
            }

            // --- Chart Logic ---
            function updateChart() {
                const stats = getPomodoroStats();
                const labels = [];
                const data = [];

                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateString = date.toISOString().split('T')[0];
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                    
                    labels.push(dayName);
                    data.push(stats[dateString] || 0);
                }

                if (pomodoroChart) {
                    pomodoroChart.data.labels = labels;
                    pomodoroChart.data.datasets[0].data = data;
                    pomodoroChart.update();
                } else {
                    const ctx = chartCanvas.getContext('2d');
                    pomodoroChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Completed Pomodoros',
                                data: data,
                                backgroundColor: 'rgba(239, 68, 68, 0.6)',
                                borderColor: 'rgba(239, 68, 68, 1)',
                                borderWidth: 1,
                                borderRadius: 5,
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }
            }

            // --- Event Listeners ---
            startPauseBtn.addEventListener('click', () => {
                playClickSound();
                if (isRunning) {
                    pauseTimer();
                } else {
                    startTimer();
                }
            });

            resetBtn.addEventListener('click', () => {
                playClickSound();
                resetTimer();
            });

            modeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    playClickSound();
                    switchMode(button.dataset.mode);
                });
            });

            settingsBtn.addEventListener('click', () => {
                playClickSound();
                settingsModal.classList.remove('hidden');
                setTimeout(() => {
                    settingsModal.classList.remove('opacity-0');
                    settingsModal.querySelector('div').classList.remove('scale-95');
                    updateChart();
                }, 10);
            });

            const closeModal = () => {
                playClickSound();
                settingsModal.classList.add('opacity-0');
                settingsModal.querySelector('div').classList.add('scale-95');
                setTimeout(() => settingsModal.classList.add('hidden'), 300);
            };

            closeSettingsBtn.addEventListener('click', closeModal);
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    closeModal();
                }
            });

            saveSettingsBtn.addEventListener('click', () => {
                durations.pomodoro = parseInt(pomodoroDurationInput.value, 10) || 25;
                durations.shortBreak = parseInt(shortBreakDurationInput.value, 10) || 5;
                durations.longBreak = parseInt(longBreakDurationInput.value, 10) || 15;
                saveSettings();
                if (currentMode === 'pomodoro') timeRemaining = durations.pomodoro * 60;
                if (currentMode === 'shortBreak') timeRemaining = durations.shortBreak * 60;
                if (currentMode === 'longBreak') timeRemaining = durations.longBreak * 60;
                if (!isRunning) {
                    updateTimerDisplay();
                }
                closeModal();
            });

            // --- Initial Setup ---
            loadSettings();
            switchMode('pomodoro');
        });
    </script>
</body>
</html>
